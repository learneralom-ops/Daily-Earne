<script>
  const tg = window.Telegram.WebApp;

  // Global error catcher
  window.addEventListener("error", function (e) {
    alert("JS Error: " + e.message); // fallback
    tg.showAlert("JS Error: " + e.message);
  });
  window.addEventListener("unhandledrejection", function (e) {
    alert("Promise Error: " + e.reason); // fallback
    tg.showAlert("Promise Error: " + e.reason);
  });

  console.log("✅ Script loaded");

  const firebaseConfig = {
    apiKey: "AIzaSyAEJRfxHkMF7YEuTl7oB7ZSDiQDxuK0-u0",
    authDomain: "daily-earne-2f8d2.firebaseapp.com",
    projectId: "daily-earne-2f8d2",
    storageBucket: "daily-earne-2f8d2.appspot.com",
    messagingSenderId: "138048965028",
    appId: "1:138048965028:web:a9ad47644cf425fe925931",
  };

  let currentUser, userRef, userData, db;

  tg.ready(() => {
    tg.showAlert("Telegram WebApp Ready ✅");
    console.log("Telegram WebApp Ready ✅");
    initializeApp().catch(handleFatalError);
  });

  async function initializeApp() {
    tg.showAlert("Initializing Firebase...");
    console.log("Initializing Firebase...");

    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();

    if (!tg.initDataUnsafe?.user) {
      throw new Error("❌ Telegram user data পাওয়া যায়নি! Bot থেকে App ওপেন করুন।");
    }

    currentUser = tg.initDataUnsafe.user;
    console.log("Telegram User:", currentUser);
    tg.showAlert("User Loaded: " + currentUser.id);

    userRef = db.collection("users").doc(currentUser.id.toString());

    const docSnap = await userRef.get();
    if (docSnap.exists()) {
      userData = docSnap.data();
      tg.showAlert("User Found in DB ✅ Balance: " + userData.balance);
    } else {
      const newUser = {
        userId: currentUser.id.toString(),
        firstName: currentUser.first_name || "",
        balance: 0,
        referrals: 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      };
      await userRef.set(newUser);
      userData = newUser;
      tg.showAlert("New User Created in DB ✅");
    }

    updateUI();
  }

  function updateUI() {
    document.getElementById("user-name").textContent =
      currentUser.first_name + " " + (currentUser.last_name || "");
    document.getElementById("user-balance").textContent = userData.balance;
    document.getElementById("referral-link").value =
      `https://t.me/Earning_Live_Bot?start=${userData.userId}`;

    document.getElementById("loading-screen").style.display = "none";
    document.getElementById("app-container").style.display = "block";
    document.body.style.opacity = "1";

    tg.showAlert("UI Updated ✅ Balance: " + userData.balance);
    console.log("UI Updated ✅", userData);
  }

  function handleFatalError(error) {
    tg.showAlert("Fatal Error: " + error.message);
    console.error("Fatal Error:", error);
    document.getElementById("loading-screen").innerHTML =
      "<p style='color:red;'>Error: " + error.message + "</p>";
  }
</script>
