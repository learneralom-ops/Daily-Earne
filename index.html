<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Daily Earning</title>

  <!-- External Scripts -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      background: #121212;
      color: #fff;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .loading-screen {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: #121212;
      color: #fff;
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
    }
    .container { display: none; }
  </style>
</head>
<body>
  <div class="loading-screen" id="loading-screen">
    <p>Loading...</p>
  </div>

  <div class="container" id="app-container">
    <h1 id="user-name">...</h1>
    <p>Balance: <span id="user-balance">0</span> টাকা</p>
    <button id="copy-btn">Copy Referral Link</button>
    <input type="text" id="referral-link" readonly />
  </div>

  <script>
    const tg = window.Telegram.WebApp;

    // ✅ Global error catcher
    window.addEventListener("error", function (e) {
      tg.showAlert("JS Error: " + e.message);
    });
    window.addEventListener("unhandledrejection", function (e) {
      tg.showAlert("Promise Error: " + e.reason);
    });

    // ✅ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAEJRfxHkMF7YEuTl7oB7ZSDiQDxuK0-u0",
      authDomain: "daily-earne-2f8d2.firebaseapp.com",
      projectId: "daily-earne-2f8d2",
      storageBucket: "daily-earne-2f8d2.appspot.com",
      messagingSenderId: "138048965028",
      appId: "1:138048965028:web:a9ad47644cf425fe925931",
    };

    let currentUser, userRef, userData, db;

    tg.ready(() => {
      initializeApp().catch(handleFatalError);
    });

    async function initializeApp() {
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      tg.expand();

      if (!tg.initDataUnsafe?.user) {
        throw new Error("Telegram user data পাওয়া যায়নি! Bot থেকে App ওপেন করুন।");
      }

      currentUser = tg.initDataUnsafe.user;
      userRef = db.collection("users").doc(currentUser.id.toString());

      const docSnap = await userRef.get();
      if (docSnap.exists()) {
        userData = docSnap.data();
      } else {
        const newUser = {
          userId: currentUser.id.toString(),
          firstName: currentUser.first_name || "",
          balance: 0,
          referrals: 0,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        };
        await userRef.set(newUser);
        userData = newUser;
      }

      updateUI();
    }

    function updateUI() {
      document.getElementById("user-name").textContent =
        currentUser.first_name + " " + (currentUser.last_name || "");
      document.getElementById("user-balance").textContent = userData.balance;
      document.getElementById("referral-link").value =
        `https://t.me/Earning_Live_Bot?start=${userData.userId}`;

      document.getElementById("loading-screen").style.display = "none";
      document.getElementById("app-container").style.display = "block";
      document.body.style.opacity = "1";
    }

    function handleFatalError(error) {
      tg.showAlert("Fatal Error: " + error.message);
      document.getElementById("loading-screen").innerHTML =
        "<p style='color:red;'>Error: " + error.message + "</p>";
    }

    // Copy Referral Link
    document.getElementById("copy-btn").addEventListener("click", () => {
      const link = document.getElementById("referral-link").value;
      navigator.clipboard.writeText(link).then(() => {
        tg.showAlert("Referral link copied!");
      });
    });
  </script>
</body>
</html>
