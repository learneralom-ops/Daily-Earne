<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Daily Earning</title>
    <!-- Telegram Web App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        /* Modern CSS Reset */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        
        /* CSS Variables for Theming */
        :root {
            --bg-color: #121212;
            --card-color: #1e1e1e;
            --text-color: #ffffff;
            --secondary-text-color: #b0b0b0;
            --primary-color: #0088cc;
            --border-color: #333;
            --success-color: #28a745;
            --error-color: #dc3545;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 15px;
            padding-bottom: 80px; /* Space for bottom nav */
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            color: var(--text-color);
            transition: opacity 0.3s;
        }

        .container { max-width: 600px; margin: 0 auto; }
        .page-content { display: none; }
        .page-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Header */
        .header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .profile-section { display: flex; align-items: center; }
        .profile-pic { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--primary-color); margin-right: 15px; object-fit: cover; }
        .profile-info h1 { font-size: 1.2rem; margin: 0; }
        .profile-info p { margin: 4px 0 0; color: var(--secondary-text-color); }
        .notice-btn { background: transparent; border: 1px solid var(--primary-color); color: var(--primary-color); padding: 8px 15px; border-radius: 20px; cursor: pointer; }

        /* General Card Style */
        .card {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        /* Dashboard */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .dashboard-grid .card { text-align: center; }
        .dashboard-grid p { margin: 0; color: var(--secondary-text-color); font-size: 0.9rem; }
        .dashboard-grid h3 { margin: 8px 0 0; font-size: 1.8rem; color: var(--primary-color); }
        
        /* Referral Section */
        .referral-section input { width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px dashed var(--primary-color); color: var(--text-color); border-radius: 8px; text-align: center; margin-bottom: 10px; }
        .btn { display: block; width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 500; cursor: pointer; margin-top: 10px; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        
        /* Withdraw Page */
        .requirements li { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .requirements span.status.success { color: var(--success-color); }
        .requirements span.status.error { color: var(--error-color); }
        .form-group { margin-bottom: 20px; }
        .form-control { width: 100%; padding: 12px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color); }
        
        /* Bottom Navigation */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--card-color); display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid var(--border-color); max-width: 600px; margin: 0 auto; z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--secondary-text-color); text-decoration: none; font-size: 0.7rem; background: none; border: none; }
        .nav-item.active { color: var(--primary-color); }
        .nav-icon { width: 24px; height: 24px; margin-bottom: 4px; }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay">Loading...</div>

    <!-- Main Container (Hidden by default) -->
    <div class="container" style="display: none;">
        <header class="header-container">
            <div class="profile-section">
                <img src="https://i.ibb.co/tZ0d4B4/profile-pic.jpg" alt="Profile" class="profile-pic" id="user-photo">
                <div class="profile-info">
                    <h1 id="user-name">Loading...</h1>
                    <p>Balance: <span id="user-balance">0.00</span> ৳</p>
                </div>
            </div>
            <button class="notice-btn" id="notice-btn">Notice</button>
        </header>

        <main id="page-wrapper">
            <!-- Home Page -->
            <div id="page-home" class="page-content active">
                <div class="dashboard-grid">
                    <div class="card"><p>Total Clicks</p><h3 id="total-clicks">0</h3></div>
                    <div class="card"><p>Total Earnings</p><h3 id="total-earning">0.00</h3></div>
                    <div class="card"><p>Ads Watched Today</p><h3 id="ads-watched">0/15</h3></div>
                    <div class="card"><p>Total Referrals</p><h3 id="total-referrals">0</h3></div>
                </div>
                <div class="card referral-section">
                    <h3>Refer & Earn!</h3>
                    <input type="text" id="referral-link" value="Loading your link..." readonly>
                    <button class="btn btn-primary" id="copy-btn">Copy Link</button>
                </div>
            </div>

            <!-- Tasks Page -->
            <div id="page-tasks" class="page-content">
                <h2>Tasks</h2>
                <div class="card">
                    <p>Watch daily ads to earn rewards.</p>
                    <button class="btn btn-primary" id="watch-ads-btn">Watch Ad (15 left)</button>
                </div>
            </div>

            <!-- Withdraw Page -->
            <div id="page-withdraw" class="page-content">
                <h2>Withdraw</h2>
                <div class="card">
                    <h4>Withdraw Requirements</h4>
                    <ul class="requirements">
                        <li><span>Minimum Balance</span><span id="balance-status" class="status error">0 / 200 ৳</span></li>
                        <li><span>Minimum Referrals</span><span id="referral-status" class="status error">0 / 10</span></li>
                    </ul>
                </div>
                <div class="card">
                    <form id="withdraw-form">
                        <div class="form-group">
                            <label>Amount</label>
                            <input type="number" id="withdraw-amount" class="form-control" placeholder="Enter amount">
                        </div>
                        <div class="form-group">
                            <label>Account Number</label>
                            <input type="tel" id="account-number" class="form-control" placeholder="Enter your Bkash/Nagad number">
                        </div>
                        <button type="submit" class="btn btn-primary" id="withdraw-submit-btn" disabled>Request Withdraw</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item active" data-page="home"><svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg><span>Home</span></button>
        <button class="nav-item" data-page="tasks"><svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg><span>Tasks</span></button>
        <button class="nav-item" data-page="withdraw"><svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z"></path><path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd"></path></svg><span>Withdraw</span></button>
    </nav>
    
    <script type="module">
        // === Firebase SDK Imports ===
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getDatabase, ref, onValue, get, set, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        // === Your New Firebase Configuration ===
        const firebaseConfig = {
          apiKey: "AIzaSyA2HUBFhHEWg4MwkJB4BVdJxUun0Gy07Ts",
          authDomain: "daily-earne-aea89.firebaseapp.com",
          databaseURL: "https://daily-earne-aea89-default-rtdb.firebaseio.com",
          projectId: "daily-earne-aea89",
          storageBucket: "daily-earne-aea89.firebasestorage.app",
          messagingSenderId: "444567470638",
          appId: "1:444567470638:web:0fa323d9f5ef6aba1155bf"
        };

        // === Global Variables ===
        let app, db, auth, tg;
        let userId, currentUser, userRef;
        let userData = {}, appSettings = {};
        const loadingOverlay = document.getElementById('loading-overlay');
        
        // === Main Initialization Function ===
        async function main() {
            tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            
            try {
                app = initializeApp(firebaseConfig);
                db = getDatabase(app);
                auth = getAuth(app);
                
                await signInAnonymously(auth);

                if (!tg.initDataUnsafe?.user?.id) {
                    throw new Error("Could not detect Telegram user. Please open from your Telegram bot.");
                }
                
                userId = tg.initDataUnsafe.user.id;
                currentUser = tg.initDataUnsafe.user;
                userRef = ref(db, 'users/' + userId);

                await loadInitialData();
                setupEventListeners();

                document.querySelector('.container').style.display = 'block';
                loadingOverlay.style.opacity = '0';
                setTimeout(() => loadingOverlay.style.display = 'none', 300);

            } catch (error) {
                console.error("Initialization failed:", error);
                loadingOverlay.innerText = `Error: ${error.message}`;
            }
        }
        
        // === Data Loading and User Creation ===
        async function loadInitialData() {
            // Load settings
            const settingsRef = ref(db, 'settings');
            const settingsSnapshot = await get(settingsRef);
            appSettings = settingsSnapshot.exists() ? settingsSnapshot.val() : {};

            // Load user data or create new user
            const userSnapshot = await get(userRef);
            if (userSnapshot.exists()) {
                userData = userSnapshot.val();
            } else {
                await createNewUser();
            }

            // Setup realtime listeners
            onValue(userRef, (snapshot) => {
                if(snapshot.exists()) {
                    userData = snapshot.val();
                    updateAllUI();
                }
            });
        }
        
        async function createNewUser() {
            const userName = ((currentUser.first_name || '') + ' ' + (currentUser.last_name || '')).trim() || 'Telegram User';
            const newUser = {
                name: userName,
                balance: 0,
                totalClicks: 0,
                adsWatched: 0,
                referrals: 0,
                joinDate: new Date().toISOString()
            };
            await set(userRef, newUser);
            userData = newUser;
        }

        // === UI Update Functions ===
        function updateAllUI() {
            if (!userData) return;
            // Profile Header
            document.getElementById('user-name').innerText = userData.name || 'User';
            document.getElementById('user-balance').innerText = (userData.balance || 0).toFixed(2);
            if (currentUser.photo_url) {
                document.getElementById('user-photo').src = currentUser.photo_url;
            }
            // Dashboard
            document.getElementById('total-clicks').innerText = userData.totalClicks || 0;
            document.getElementById('total-earning').innerText = (userData.balance || 0).toFixed(2);
            document.getElementById('ads-watched').innerText = `${userData.adsWatched || 0}/15`;
            document.getElementById('total-referrals').innerText = userData.referrals || 0;
            // Referral Link
            document.getElementById('referral-link').value = `https://t.me/Daily_Earne_Bot?start=${userId}`;
            // Withdraw Status
            checkWithdrawStatus();
        }

        function checkWithdrawStatus() {
            const minBalance = appSettings.minWithdrawAmount || 200;
            const minRefs = appSettings.minWithdrawReferrals || 10;
            
            const hasEnoughBalance = (userData.balance || 0) >= minBalance;
            const hasEnoughRefs = (userData.referrals || 0) >= minRefs;

            const balanceEl = document.getElementById('balance-status');
            const refEl = document.getElementById('referral-status');

            balanceEl.textContent = `${(userData.balance || 0).toFixed(2)} / ${minBalance} ৳`;
            balanceEl.className = `status ${hasEnoughBalance ? 'success' : 'error'}`;
            
            refEl.textContent = `${userData.referrals || 0} / ${minRefs}`;
            refEl.className = `status ${hasEnoughRefs ? 'success' : 'error'}`;

            document.getElementById('withdraw-submit-btn').disabled = !(hasEnoughBalance && hasEnoughRefs);
        }

        // === Event Listeners Setup ===
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelector('.nav-item.active').classList.remove('active');
                    item.classList.add('active');
                    document.querySelector('.page-content.active').classList.remove('active');
                    document.getElementById(`page-${item.dataset.page}`).classList.add('active');
                });
            });

            // Copy Button
            document.getElementById('copy-btn').addEventListener('click', () => {
                const link = document.getElementById('referral-link').value;
                navigator.clipboard.writeText(link).then(() => {
                    tg.HapticFeedback.notificationOccurred('success');
                    alert('Referral link copied!');
                });
            });

            // Notice Button
            document.getElementById('notice-btn').addEventListener('click', () => {
                const notice = appSettings.noticeContent || "No notice available.";
                tg.showAlert(notice);
            });
        }

        // === Run the App ===
        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>
